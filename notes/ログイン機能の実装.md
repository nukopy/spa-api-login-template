# 世の中に存在するログイン機能を一通り実装してみた

<!-- Web アプリケーションのログイン機能を実現する際、ユーザはどのような動作でログインをするのか、どんな技術が必要かを。 -->

## 対象読者

- ログイン機能の考え方の基本を理解したい方
- ログイン機能のいくつかのパターンを一通り学びたい方
- ログイン機能の実装の仕方が分からない方

## 注意

実装パートに関しては、Web アプリケーションの開発をやったことがある人でないと少しだけ分かりづらいかもしれません。

また、コードを 1 行 1 行解説することはせず、実装の要点だけ説明します。
ソースコードは公開しているので自分で読んで動かしてみることをおすすめします。

## 構成

- ログインとは
- どうすればログインを実装できるか考える
- 認証、認可とは
- 色々なログイン機能：各論
  - パターン一覧
    - BASIC 認証
    - セッション認証
    - JWT
- 色々なログイン機能
  - パターン一覧
    - BASIC 認証
    - セッション認証
    - JWT
  - 各論
  - 実装
- 参考

## ログインとは

まず、そもそもログインとはなにか、そしてそれがなぜ必要かを考える。「ログイン」の定義とその役割・意義を確認し、我々が実装したい「ログイン」機能の大枠を把握する。

## どうすればログインを実装できるか考える

### Cookie とセッション

### 認証、認可とは

## 色々なログイン機能

### パターン一覧

- BASIC 認証
- セッション認証
- JWT
  - Cognite
- OAuth2: Social Authentication

### 各論

それぞれの利点、脆弱性、どんな対策が必要かを把握する。

#### BASIC 認証

#### セッション認証

#### JWT

- よくある localStorage 論争について触れる

### アプリケーションの要件定義、設計

これまで紹介したログインのパターンを実装してみます。今回作成する Web アプリケーションは、ログイン機能を有するだけの非常にシンプルなものを作っていきますが、話の全体像が分かるように簡単な要件定義、設計を行った上で実装を行っていきます。

#### 要件定義

まず、実装する Web アプリケーションの（ゆるふわな）要件定義を行います。非常にシンプルな構成のアプリケーションを考えます。

- 要件定義
  - 概要
    - ログイン機能を持ったシンプルな Web アプリケーション。
  - 必須要件
    - ログイン機能
      - ログインの状態は非ログイン / ログインの 2 状態
    - ユーザのログイン状態によって、見ることができる情報を変える

必要な機能はこれだけで、ユーザはこのアプリケーション上で以下のような一連の操作をすることができる。

1. ブラウザからトップページにアクセス
2. ログインボタンを押す
3. ログインユーザしか見れないページが見れる
4. トップページに戻る
5. ログアウト
6. 1 に戻る

#### 設計

要件定義の次は、アプリケーションの設計を行っていきます。

##### システム設計

フロントエンド、バックエンドを SPA + API サーバの構成で Web アプリケーションを実装し、それぞれを Docker Compose でコンテナとして動作させます。一部認証基盤としてクラウドサービスを使用する部分もありますが、アプリケーションは基本ローカル（`http://localhost`）で動作させます。

- アプリケーション
  - フロントエンド
    - TypeScript / Next.js
  - バックエンド
    - Python / FastAPI
  - DB
    - MySQL
- Docker Compose

##### フロントエンドの設計

<!-- 画面遷移は 3 画面だけです。トップページ、ログインページ、ログインユーザのみ見ることができるページの 2 つです。 -->

- フロントエンド（SPA）
  - トップページ：`/`
    - ログインボタンを設置する。ログイン状態の ON/OFF で以下のように表示を変える。
      - 非ログイン：ボタン 2 つ "Sign In"、"Sign Up"
      - ログイン：ボタン 2 つ "Go to App Page"、"Sign Out"
      - Social Authentication を利用する場合、外部のページへ飛ぶ場合もある。
  - ログインページ：`/login`
    - パスワード入力などを行う
  - ログインユーザのみ見ることができるページ：`/app`
    - ログインした人しか見れないページ。
    - ログインしていない（ログイン状態を保持していない）場合、`/login` へリダイレクトされるようにする。

<!-- TODO：画面をここで示す -->

##### バックエンドの設計

バックエンドは API サーバとして動作させます。エンドポイントは基本的に `/api/auth` と `/api/app` の 2 つです。ログインの方式によってエンドポイントをいくつか増やす場合もあります。

- バックエンド（API サーバ）
  - `/api/auth`：auth 用のエンドポイント（ログインユーザ）
  - `/api/app`：ログインしたユーザしか叩けないエンドポイント
    - トークンとかセッションとかでリクエストの可否を処理する

### 実装

上記の要件定義、設計を元にして、各論で紹介したログインの方式を実装していきます。

- BASIC 認証
- セッション認証
- JWT
  - Cognite
- OAuth2: Social Authentication

## ハマったポイントとか

- CORS

---

---

### Cookie とセッション

- Cookie とは、ユーザーがウェブサイトにアクセスしたときにブラウザに送られてくる小さなテキストデータです。ウェブサイトは、Cookie を使ってユーザーのアクセスに関する情報を記録しておくことで、次回ユーザーがアクセスする際に、ウェブサイトをより簡単かつ便利に活用できるようにします。
- たとえば、ユーザーの優先言語を保存したり、表示される広告の関連性を向上させたりするために Cookie を使用しています。ページへの訪問者数のカウント、Google のサービスへの登録サポート、ユーザーのデータの保護、ユーザーの広告設定の保存といったことにも Cookie は使用されています。

## Cookie 認証と
